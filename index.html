<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADDR SNOWEEK</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        h1, h2, h3 { font-family: 'Outfit', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select, textarea { font-size: 16px !important; } 
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getDatabase, ref, onValue, set } from 'firebase/database';
        import { Calendar, ShoppingCart, Settings, RotateCcw, X, Users, Plus, Trash2, Save, Store, Loader2, ArrowDown, Edit2, CheckCircle2, Circle, Coffee, AlertTriangle } from 'lucide-react';

        // --- CONFIG FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVWhMBU1_j1sM78EahtaMX8KAlsiGUUFA",
            authDomain: "addrsnoweek.firebaseapp.com",
            databaseURL: "https://addrsnoweek-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "addrsnoweek",
            storageBucket: "addrsnoweek.firebasestorage.app",
            messagingSenderId: "466240679395",
            appId: "1:466240679395:web:a59f6a72e061560a1f44d6",
            measurementId: "G-VLPH0412KY"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const DB_PATH = 'snoweek_data_v1'; 

        // --- CONSTANTES ---
        const DEFAULT_PARTICIPANTS = ["Amau", "Ani", "David", "Jojo", "Laure", "Léo", "Lucile", "Nathan", "Paloma", "Ségo", "Solé", "Thib", "Youri"];
        const UNITS = [
            "g", 
            "kg", 
            "ml", 
            "cl", 
            "L", 
            "unité(s)", 
            "boîte(s)", 
            "botte(s)", 
            "bouteille(s)", 
            "gousse(s)", 
            "paquet(s)", 
            "pot(s)", 
            "sachet(s)"
        ];
        const DAYS_OF_WEEK = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
        const MONTHS = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
        const CONVERSIONS = { 'g': {type:'weight',factor:1}, 'kg': {type:'weight',factor:1000}, 'ml': {type:'volume',factor:1}, 'cl': {type:'volume',factor:10}, 'L': {type:'volume',factor:1000} };

        // --- UTILITAIRES ---
        const formatDate = (date) => {
            const y = date.getFullYear();
            const m = MONTHS[date.getMonth()];
            const d = date.getDate().toString().padStart(2, '0');
            return `${y}-${m}-${d}`;
        };
        const getDayLabel = (date) => `${DAYS_OF_WEEK[date.getDay()]} ${date.getDate().toString().padStart(2, '0')}`;
        const addDays = (dateStr, days) => {
            const date = new Date(dateStr);
            date.setDate(date.getDate() + days);
            return formatDate(date);
        };

        const generateSchedule = (startDateStr, startPeriod, endDateStr, endPeriod) => {
            let current = new Date(startDateStr);
            const end = new Date(endDateStr);
            const slots = [];
            let guard = 0;
            let isMidi = startPeriod === 'Midi';

            while (guard < 100) {
                const dateStr = formatDate(current);
                if (current > end) break;
                if (dateStr === endDateStr && endPeriod === 'Midi' && !isMidi) break;
                const type = isMidi ? 'Midi' : 'Soir';
                slots.push({
                    id: `${dateStr}-${type}`,
                    date: dateStr,
                    dayName: getDayLabel(current),
                    type: type,
                    isRestaurant: false,
                    recipeName: '',
                    cooks: [], ingredients: [],
                    pax: ''
                });
                if (dateStr === endDateStr && ((endPeriod === 'Midi' && type === 'Midi') || (endPeriod === 'Soir' && type === 'Soir'))) break;
                if (!isMidi) current.setDate(current.getDate() + 1);
                isMidi = !isMidi;
                guard++;
            }
            return slots;
        };

        const BREAKFAST_SLOT = {
            id: 'breakfast-global',
            date: 'global',
            dayName: 'TOUS LES MATINS',
            type: 'Petit Déj',
            isRestaurant: false,
            recipeName: 'Petit Déjeuner',
            cooks: [], 
            ingredients: [],
            pax: '13'
        };

        const DEFAULT_START_DATE = '2026-01-24';
        const DEFAULT_START_PERIOD = 'Midi';
        const DEFAULT_END_DATE = '2026-02-01';
        const DEFAULT_END_PERIOD = 'Midi';
        const INITIAL_SLOTS = [BREAKFAST_SLOT, ...generateSchedule(DEFAULT_START_DATE, DEFAULT_START_PERIOD, DEFAULT_END_DATE, DEFAULT_END_PERIOD)];
        
        const DEFAULT_STATE = {
            startDate: DEFAULT_START_DATE,
            startPeriod: DEFAULT_START_PERIOD,
            endDate: DEFAULT_END_DATE,
            endPeriod: DEFAULT_END_PERIOD,
            slots: INITIAL_SLOTS,
            participants: DEFAULT_PARTICIPANTS,
            tripName: 'ADDR SNOWEEK',
            version: 3
        };

        // --- COMPOSANTS ---

        const ParticipantManager = ({ participants, onChange }) => {
            const safeParticipants = participants || [];
            const [newName, setNewName] = useState('');
            const handleAdd = (e) => {
                e.preventDefault();
                if (newName.trim() && !safeParticipants.includes(newName.trim())) {
                    onChange([...safeParticipants, newName.trim()].sort());
                    setNewName('');
                }
            };
            return (
                <div className="space-y-4">
                    <form onSubmit={handleAdd} className="flex gap-2">
                        <input type="text" value={newName} onChange={(e) => setNewName(e.target.value)} placeholder="Ajouter un nom..." className="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl font-bold text-slate-900"/>
                        <button type="submit" disabled={!newName.trim()} className="px-3 bg-blue-600 text-white rounded-xl"><Plus size={20}/></button>
                    </form>
                    <div className="flex flex-wrap gap-2">
                        {safeParticipants.map((name) => (
                            <div key={name} className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 border border-slate-200 rounded-lg text-xs font-bold text-slate-700">
                                {name} <button type="button" onClick={() => safeParticipants.length > 1 ? onChange(safeParticipants.filter(p => p !== name)) : alert("Impossible de tout supprimer")} className="text-red-400 font-bold ml-1 hover:text-red-600">x</button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ onClose, state, onSave, onReset }) => {
            const [localStart, setLocalStart] = useState(state.startDate || DEFAULT_START_DATE);
            const [localStartPeriod, setLocalStartPeriod] = useState(state.startPeriod || 'Midi');
            const [localEnd, setLocalEnd] = useState(state.endDate || addDays(state.startDate, 7));
            const [localEndPeriod, setLocalEndPeriod] = useState(state.endPeriod || 'Midi');
            const [localParticipants, setLocalParticipants] = useState(state.participants || DEFAULT_PARTICIPANTS);
            const [isSaving, setIsSaving] = useState(false);

            const handleGlobalSave = async () => {
                setIsSaving(true);
                try {
                    await onSave(localStart, localStartPeriod, localEnd, localEndPeriod, localParticipants);
                    onClose();
                } catch (e) {
                    alert("Erreur: " + e.message);
                }
                setIsSaving(false);
            };

            const handleResetClick = async () => {
                if (confirm('⚠️ Vider tout le planning ?\n\nCela effacera tous les repas mais gardera les dates et les participants.')) {
                    setIsSaving(true);
                    await onReset();
                    onClose(); // On ferme la modale après le reset
                }
            };

            return (
                <div className="fixed inset-0 z-50 bg-black/50 flex justify-end animate-in fade-in duration-200">
                    <div className="bg-white w-full max-w-sm h-full p-6 overflow-y-auto shadow-2xl animate-in slide-in-from-right duration-300 flex flex-col">
                        <div className="flex justify-between items-center mb-8 shrink-0"><h2 className="font-black text-2xl tracking-tight">Paramètres</h2><button onClick={onClose} className="p-2 bg-slate-50 rounded-full"><X/></button></div>
                        <div className="space-y-8 flex-1">
                            <section className="space-y-4">
                                <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2"><Calendar size={14}/> Dates du séjour</h3>
                                <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-4">
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Début</label>
                                        <div className="flex flex-col gap-2 mt-1">
                                            <input type="date" className="w-full p-3 bg-white border-2 border-slate-200 rounded-xl font-bold text-slate-900" value={localStart} onChange={(e) => setLocalStart(e.target.value)}/>
                                            <div className="flex bg-white rounded-xl p-1 border-2 border-slate-200">
                                                {['Midi', 'Soir'].map(p => (<button type="button" key={p} onClick={() => setLocalStartPeriod(p)} className={`flex-1 py-1.5 rounded-lg text-xs font-black transition-all ${localStartPeriod === p ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400'}`}>{p}</button>))}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex justify-center text-slate-300"><ArrowDown size={16}/></div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Fin</label>
                                        <div className="flex flex-col gap-2 mt-1">
                                            <input type="date" className="w-full p-3 bg-white border-2 border-slate-200 rounded-xl font-bold text-slate-900" value={localEnd} onChange={(e) => setLocalEnd(e.target.value)}/>
                                            <div className="flex bg-white rounded-xl p-1 border-2 border-slate-200">
                                                {['Midi', 'Soir'].map(p => (<button type="button" key={p} onClick={() => setLocalEndPeriod(p)} className={`flex-1 py-1.5 rounded-lg text-xs font-black transition-all ${localEndPeriod === p ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400'}`}>{p}</button>))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <section className="space-y-4">
                                <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2"><Users size={14}/> Participants</h3>
                                <ParticipantManager participants={localParticipants} onChange={setLocalParticipants}/>
                            </section>
                        </div>
                        <div className="pt-6 mt-6 border-t space-y-3 shrink-0">
                            <button type="button" onClick={handleGlobalSave} disabled={isSaving} className="w-full py-4 bg-blue-600 text-white font-bold rounded-xl shadow-xl shadow-blue-200 flex items-center justify-center gap-2 active:scale-95 transition-all disabled:opacity-50">
                                {isSaving ? <Loader2 className="animate-spin"/> : <Save size={20}/>}
                                {isSaving ? 'Enregistrement...' : 'Enregistrer les réglages'}
                            </button>
                            <button type="button" onClick={handleResetClick} disabled={isSaving} className="w-full py-4 bg-red-50 text-red-500 font-bold rounded-xl flex items-center justify-center gap-2 hover:bg-red-100 transition-colors">
                                <Trash2 size={16}/> Vider le planning
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ShoppingItemEditModal = ({ item, onClose, onSave }) => {
            const [newName, setNewName] = useState(item.displayName);
            const [newUnit, setNewUnit] = useState(item.displayUnit);

            const handleSave = () => {
                onSave(item.refs, newName, newUnit);
            };

            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in fade-in duration-200 p-4">
                    <div className="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden flex flex-col">
                        <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="font-black text-lg">Modifier l'article</h3>
                            <button onClick={onClose} className="p-2 bg-slate-50 hover:bg-slate-100 rounded-full"><X size={20}/></button>
                        </div>
                        <div className="p-6 space-y-5">
                            <div className="space-y-2">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Nom de l'article</label>
                                <input className="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl font-bold text-slate-900 focus:border-blue-500 outline-none" 
                                    value={newName} onChange={e => setNewName(e.target.value)} />
                                <p className="text-xs text-slate-400 px-1">Changer le nom pour corriger l'orthographe ou fusionner avec un autre article.</p>
                            </div>
                            <div className="space-y-2">
                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Unité</label>
                                <select className="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl font-bold text-slate-900 focus:border-blue-500 outline-none"
                                    value={newUnit} onChange={e => setNewUnit(e.target.value)}>
                                    {UNITS.map(u => <option key={u} value={u}>{u}</option>)}
                                </select>
                                <p className="text-xs text-slate-400 px-1">Appliquer cette unité à toutes les occurrences de cet ingrédient.</p>
                            </div>
                            
                            <div className="bg-blue-50 p-3 rounded-xl border border-blue-100">
                                <div className="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-2">Utilisé dans :</div>
                                <div className="flex flex-wrap gap-1">
                                    {item.sources.map(s => (
                                        <span key={s} className="bg-white text-blue-600 border border-blue-100 text-[10px] font-bold px-2 py-1 rounded-lg shadow-sm">
                                            {s}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div className="p-4 border-t bg-slate-50 flex gap-3">
                            <button onClick={onClose} className="flex-1 py-3 font-bold text-slate-500 hover:bg-slate-200 rounded-xl transition-colors">Annuler</button>
                            <button onClick={handleSave} className="flex-[2] py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-200 active:scale-95 transition-all">Enregistrer</button>
                        </div>
                    </div>
                </div>
            );
        };

        const MealEditModal = ({ slot, participants, onClose, onSave }) => {
            const [localSlot, setLocalSlot] = useState({
                ...slot,
                recipeName: slot.recipeName || '',
                isRestaurant: slot.isRestaurant || false,
                cooks: slot.cooks || [],
                ingredients: slot.ingredients || [],
                pax: slot.pax || ''
            });
            const [lastAddedId, setLastAddedId] = useState(null);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const nameInputRefs = useRef({});
            
            const safeSlot = localSlot; 
            const isBreakfast = slot.id === 'breakfast-global';

            const addIng = () => {
                // Prevent empty ingredient addition
                const lastIng = safeSlot.ingredients[safeSlot.ingredients.length - 1];
                if (lastIng && (!lastIng.name || lastIng.name.trim() === '')) {
                    if (nameInputRefs.current[lastIng.id]) {
                        nameInputRefs.current[lastIng.id].focus();
                    }
                    return;
                }

                const newId = crypto.randomUUID();
                setLastAddedId(newId);
                setLocalSlot({...safeSlot, ingredients: [...safeSlot.ingredients, {id: newId, name:'', quantity:1, unit: UNITS[0]}]});
            };

            const handleIngKeyDown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addIng();
                }
            };

            const updateIng = (id, f, v) => setLocalSlot({...safeSlot, ingredients: safeSlot.ingredients.map(i=>i.id===id?{...i,[f]:v}:i)});
            const toggleCook = (name) => {
                const currentCooks = safeSlot.cooks || [];
                setLocalSlot({...safeSlot, cooks: currentCooks.includes(name) ? currentCooks.filter(c => c !== name) : [...currentCooks, name]});
            };

            const handleSave = () => {
                const cleanSlot = {
                    ...localSlot,
                    ingredients: localSlot.ingredients.filter(i => i.name && i.name.trim() !== '')
                };
                onSave(cleanSlot);
            };

            const handleResetClick = () => {
                // Close keyboard immediately
                if (document.activeElement instanceof HTMLElement) {
                    document.activeElement.blur();
                }
                setShowResetConfirm(true);
            };

            const confirmReset = () => {
                const emptySlot = {
                    ...safeSlot,
                    recipeName: isBreakfast ? 'Petit Déjeuner' : '',
                    isRestaurant: false,
                    cooks: [],
                    ingredients: [],
                    pax: isBreakfast ? '13' : ''
                };
                onSave(emptySlot);
                setShowResetConfirm(false); // Not strictly needed as modal closes/updates, but good practice
            };

            useEffect(() => {
                if (lastAddedId && nameInputRefs.current[lastAddedId]) {
                    nameInputRefs.current[lastAddedId].focus();
                    setLastAddedId(null);
                }
            }, [lastAddedId, safeSlot.ingredients]);

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/80 p-0 sm:p-4 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-none sm:rounded-2xl w-full h-full sm:h-auto sm:max-h-[90vh] sm:max-w-lg shadow-2xl flex flex-col overflow-hidden relative">
                        
                        {/* HEADER */}
                        <div className="px-4 py-3 border-b flex justify-between items-center bg-white shrink-0 z-10">
                            <div><h2 className="font-black text-lg text-slate-900 leading-none">{slot.dayName}</h2><p className="text-blue-500 text-xs font-black uppercase tracking-widest">{slot.type}</p></div>
                            {!isBreakfast && (
                            <div className="flex items-center gap-2 bg-slate-100 p-1 pr-3 rounded-full">
                                <button onClick={() => setLocalSlot({...safeSlot, isRestaurant: !safeSlot.isRestaurant})} className={`w-9 h-5 rounded-full relative transition-colors duration-200 ${safeSlot.isRestaurant ? 'bg-orange-500' : 'bg-slate-300'}`}><div className={`w-3.5 h-3.5 bg-white rounded-full absolute top-0.5 transition-all duration-200 shadow-sm ${safeSlot.isRestaurant ? 'left-[1.1rem]' : 'left-1'}`}/></button>
                                <span className={`text-[10px] font-black uppercase ${safeSlot.isRestaurant ? 'text-orange-500' : 'text-slate-400'}`}>{safeSlot.isRestaurant ? 'Resto' : 'Cuisine'}</span>
                            </div>
                            )}
                            <button onClick={onClose} className="p-2 bg-slate-50 hover:bg-slate-100 rounded-full text-slate-400"><X size={20}/></button>
                        </div>

                        {/* BODY */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-5 bg-slate-50/50">
                            {safeSlot.isRestaurant ? (
                                <div className="flex flex-col items-center justify-center h-64 text-slate-400 animate-in zoom-in-95"><Store size={48} className="text-orange-300 mb-3"/><p className="font-black text-lg text-orange-400 uppercase">Sortie Restaurant</p><p className="text-xs font-medium text-slate-400 mt-1">Aucune course nécessaire</p></div>
                            ) : (
                                <>
                                    {!isBreakfast ? (
                                    <>
                                        <div className="space-y-1.5"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Au Menu</label><input className="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:outline-none font-bold text-base text-slate-900 shadow-sm placeholder:text-slate-300" placeholder="Ex: Tartiflette..." value={safeSlot.recipeName} onChange={e=>setLocalSlot({...safeSlot, recipeName: e.target.value})}/></div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="space-y-1.5"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Convives (Pax)</label><input type="number" className="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:outline-none font-bold text-base text-slate-900 shadow-sm" placeholder="13" value={safeSlot.pax} onChange={e=>setLocalSlot({...safeSlot, pax: e.target.value})}/></div>
                                        </div>
                                        <div className="space-y-1.5"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Chefs Cuistots</label><div className="flex flex-wrap gap-1.5">{participants.map(p => (<button key={p} onClick={() => toggleCook(p)} className={`px-3 py-2 rounded-lg text-xs font-bold border transition-all active:scale-95 ${safeSlot.cooks.includes(p)? 'bg-blue-600 border-blue-600 text-white shadow-md' : 'bg-white border-slate-200 text-slate-500'}`}>{p}</button>))}</div></div>
                                    </>
                                    ) : (
                                        <div className="space-y-1.5"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Nombre de personnes</label><input type="number" className="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:outline-none font-bold text-base text-slate-900 shadow-sm" placeholder="13" value={safeSlot.pax} onChange={e=>setLocalSlot({...safeSlot, pax: e.target.value})}/></div>
                                    )}
                                    <div className="space-y-2 pt-2">
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Liste des Ingrédients</label>
                                        <div className="space-y-2 pb-10">
                                            {safeSlot.ingredients.length === 0 && (<div className="text-center py-6 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50"><p className="text-xs text-slate-400 font-medium">Liste vide</p></div>)}
                                            {safeSlot.ingredients.map(ing => (
                                                <div key={ing.id} className="flex items-center gap-1.5 sm:gap-2 animate-in slide-in-from-left-2 duration-200">
                                                    <input type="number" className="w-14 sm:w-16 px-1 py-3 bg-white border border-slate-200 rounded-lg text-center text-base font-bold text-slate-900 focus:border-blue-500 focus:outline-none shrink-0" value={ing.quantity} onChange={e=>updateIng(ing.id,'quantity',e.target.value)} onKeyDown={handleIngKeyDown} />
                                                    <select className="w-[4.5rem] sm:w-20 px-0 sm:px-1 py-3 bg-white border border-slate-200 rounded-lg text-[10px] sm:text-[11px] font-bold text-slate-600 focus:border-blue-500 focus:outline-none text-center shrink-0" value={ing.unit} onChange={e=>updateIng(ing.id,'unit',e.target.value)} onKeyDown={handleIngKeyDown} >{UNITS.map(u => <option key={u} value={u}>{u}</option>)}</select>
                                                    <input ref={el => nameInputRefs.current[ing.id] = el} className="flex-1 min-w-0 px-3 py-3 bg-white border border-slate-200 rounded-lg text-base font-bold text-slate-900 focus:border-blue-500 focus:outline-none placeholder:text-slate-300" placeholder="Ingrédient..." value={ing.name} onChange={e=>updateIng(ing.id,'name',e.target.value)} onKeyDown={handleIngKeyDown} />
                                                    <button onClick={()=>setLocalSlot({...safeSlot, ingredients: safeSlot.ingredients.filter(i=>i.id!==ing.id)})} className="shrink-0 p-2 text-slate-300 hover:text-red-500 transition-colors"><Trash2 size={20}/></button>
                                                </div>
                                            ))}
                                            <button onClick={addIng} className="w-full mt-3 py-3 rounded-xl border-2 border-dashed border-blue-200 bg-blue-50 text-blue-600 font-black text-sm flex items-center justify-center gap-2 hover:bg-blue-100 transition-all active:scale-[0.98]"><Plus size={18}/> Ajouter un ingrédient</button>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                        
                        {/* FOOTER */}
                        <div className="p-3 border-t bg-white flex gap-3 shrink-0 pb-6 sm:pb-3 z-10">
                            <button onClick={handleResetClick} className="flex-1 py-2.5 rounded-lg border border-red-200 text-red-500 font-bold text-sm hover:bg-red-50 transition-all flex items-center justify-center gap-2"><Trash2 size={16}/> RESET</button>
                            <button onClick={handleSave} className="flex-[2] py-2.5 bg-blue-600 text-white rounded-lg font-black text-sm shadow-lg shadow-blue-100 flex items-center justify-center gap-2 active:scale-95 transition-all"><Save size={16}/> Enregistrer</button>
                        </div>

                        {/* CONFIRMATION OVERLAY */}
                        {showResetConfirm && (
                            <div className="absolute inset-0 z-20 bg-slate-900/10 backdrop-blur-[2px] flex items-end sm:items-center justify-center animate-in fade-in duration-200">
                                <div className="bg-white w-full sm:w-80 m-4 p-6 rounded-2xl shadow-2xl border border-slate-100 animate-in slide-in-from-bottom-10 sm:slide-in-from-bottom-0 sm:zoom-in-95 duration-200">
                                    <div className="flex flex-col items-center text-center space-y-4">
                                        <div className="p-3 bg-red-100 rounded-full text-red-500 mb-2">
                                            <AlertTriangle size={32} />
                                        </div>
                                        <h3 className="font-black text-xl text-slate-900">Tout effacer ?</h3>
                                        <p className="text-sm text-slate-500 font-medium">Voulez-vous vraiment supprimer tout le contenu de ce repas ? Cette action est irréversible.</p>
                                        <div className="flex gap-3 w-full pt-2">
                                            <button onClick={() => setShowResetConfirm(false)} className="flex-1 py-3 rounded-xl bg-slate-100 text-slate-600 font-bold text-sm">Annuler</button>
                                            <button onClick={confirmReset} className="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold text-sm shadow-lg shadow-red-200">Effacer</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )
        };

        const App = () => {
            const [state, setState] = useState(null);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('planner');
            const [isAdminOpen, setIsAdminOpen] = useState(false);
            const [selectedSlot, setSelectedSlot] = useState(null);
            const [editingItem, setEditingItem] = useState(null); // Pour l'édition d'ingrédient
            const [draggedSlotId, setDraggedSlotId] = useState(null);

            // CONNEXION FIREBASE
            useEffect(() => {
                const dataRef = ref(db, DB_PATH);
                const unsubscribe = onValue(dataRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // Migration: Ensure breakfast slot exists
                        if (!data.slots.some(s => s.id === 'breakfast-global')) {
                            data.slots.unshift(BREAKFAST_SLOT);
                        }
                        setState(data);
                    } else {
                        set(dataRef, DEFAULT_STATE);
                    }
                }, (err) => {
                    console.error(err);
                    setError(err.message);
                });
                return () => unsubscribe();
            }, []);

            const save = (newState) => {
                return set(ref(db, DB_PATH), newState);
            };

            const handleScheduleUpdate = async (newStart, newStartPeriod, newEnd, newEndPeriod, newParticipants) => {
                let newState = { ...state };
                if (newParticipants) newState.participants = newParticipants;
                
                const datesChanged = newStart !== state.startDate || newStartPeriod !== state.startPeriod || newEnd !== state.endDate || newEndPeriod !== state.endPeriod;
                if (datesChanged && newStart && newEnd) {
                    const breakfast = state.slots.find(s => s.id === 'breakfast-global') || BREAKFAST_SLOT;
                    const newTimeSlots = generateSchedule(newStart, newStartPeriod, newEnd, newEndPeriod);
                    
                    const mergedTimeSlots = newTimeSlots.map((newSlot) => {
                        const existingSlot = state.slots.find(old => old.date === newSlot.date && old.type === newSlot.type);
                        if (existingSlot) {
                            return { 
                                ...newSlot, 
                                recipeName: existingSlot.recipeName||'', 
                                isRestaurant: existingSlot.isRestaurant||false, 
                                cooks: existingSlot.cooks||[], 
                                ingredients: existingSlot.ingredients||[],
                                pax: existingSlot.pax||''
                            };
                        }
                        return newSlot;
                    });

                    newState.startDate = newStart;
                    newState.startPeriod = newStartPeriod;
                    newState.endDate = newEnd;
                    newState.endPeriod = newEndPeriod;
                    newState.slots = [breakfast, ...mergedTimeSlots];
                }
                
                await save(newState);
            };

            const resetAll = async () => {
                const emptySlots = state.slots.map(slot => ({
                    ...slot,
                    recipeName: slot.id === 'breakfast-global' ? 'Petit Déjeuner' : '',
                    isRestaurant: false,
                    cooks: [],
                    ingredients: [],
                    pax: slot.id === 'breakfast-global' ? '13' : ''
                }));
                
                await save({
                    ...state,
                    slots: emptySlots
                });
            };

            // UPDATE SHOPPING ITEM (Renaming / Changing unit)
            const handleShoppingItemUpdate = (refs, newName, newUnit) => {
                const newSlots = [...state.slots];
                let changed = false;

                refs.forEach(ref => {
                    const slotIndex = newSlots.findIndex(s => s.id === ref.slotId);
                    if (slotIndex > -1) {
                        const slot = newSlots[slotIndex];
                        // Need to create a new copy of ingredients array if we touch it
                        const newIngredients = [...slot.ingredients];
                        const ingIndex = newIngredients.findIndex(i => i.id === ref.ingId);
                        
                        if (ingIndex > -1) {
                            // Update the ingredient
                            newIngredients[ingIndex] = { 
                                ...newIngredients[ingIndex], 
                                name: newName, 
                                unit: newUnit 
                            };
                            newSlots[slotIndex] = { ...slot, ingredients: newIngredients };
                            changed = true;
                        }
                    }
                });

                if (changed) {
                    save({ ...state, slots: newSlots });
                    setEditingItem(null);
                }
            };
            
            // TOGGLE SHOPPING ITEM CHECK
            const handleToggleShoppingItem = (item) => {
                const newSlots = [...state.slots];
                const targetStatus = !item.checked;
                
                item.refs.forEach(ref => {
                    const slotIndex = newSlots.findIndex(s => s.id === ref.slotId);
                    if (slotIndex > -1) {
                        const newIngredients = [...newSlots[slotIndex].ingredients];
                        const ingIndex = newIngredients.findIndex(i => i.id === ref.ingId);
                        
                        if (ingIndex > -1) {
                            // Update checked status
                            newIngredients[ingIndex] = { ...newIngredients[ingIndex], checked: targetStatus };
                            newSlots[slotIndex] = { ...newSlots[slotIndex], ingredients: newIngredients };
                        }
                    }
                });
                
                save({ ...state, slots: newSlots });
            };

            // DRAG AND DROP (SWAP) LOGIC
            const handleDragStart = (e, slotId) => {
                setDraggedSlotId(slotId);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', slotId);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDrop = (e, targetSlotId) => {
                e.preventDefault();
                if (!draggedSlotId || draggedSlotId === targetSlotId) return;

                const sourceIndex = state.slots.findIndex(s => s.id === draggedSlotId);
                const targetIndex = state.slots.findIndex(s => s.id === targetSlotId);

                if (sourceIndex === -1 || targetIndex === -1) return;

                const newSlots = [...state.slots];
                const sourceSlot = newSlots[sourceIndex];
                const targetSlot = newSlots[targetIndex];

                const temp = {
                    recipeName: sourceSlot.recipeName || '',
                    isRestaurant: sourceSlot.isRestaurant || false,
                    cooks: sourceSlot.cooks || [],
                    ingredients: sourceSlot.ingredients || [],
                    pax: sourceSlot.pax || ''
                };

                newSlots[sourceIndex] = {
                    ...sourceSlot,
                    recipeName: targetSlot.recipeName || '',
                    isRestaurant: targetSlot.isRestaurant || false,
                    cooks: targetSlot.cooks || [],
                    ingredients: targetSlot.ingredients || [],
                    pax: targetSlot.pax || ''
                };

                newSlots[targetIndex] = {
                    ...targetSlot,
                    recipeName: temp.recipeName,
                    isRestaurant: temp.isRestaurant,
                    cooks: temp.cooks,
                    ingredients: temp.ingredients,
                    pax: temp.pax
                };

                save({ ...state, slots: newSlots });
                setDraggedSlotId(null);
            };

            const handleCardClick = (slot) => {
                if (draggedSlotId && draggedSlotId !== slot.id) {
                    handleDrop({ preventDefault: () => {} }, slot.id);
                } else if (draggedSlotId === slot.id) {
                    setDraggedSlotId(null);
                } else {
                    setSelectedSlot(slot);
                }
            };

            const handleMobileMoveClick = (e, slotId) => {
                e.stopPropagation();
                if (draggedSlotId === slotId) setDraggedSlotId(null);
                else setDraggedSlotId(slotId);
            };

            const stats = useMemo(() => {
                if (!state || !state.slots) return { resto: 0, cooked: 0, todo: 0 };
                return state.slots.reduce((acc, slot) => {
                    if (slot.id === 'breakfast-global') return acc; // Skip breakfast in stats
                    if (slot.isRestaurant) acc.resto++;
                    else if (slot.recipeName && slot.recipeName.trim() !== '') acc.cooked++;
                    else acc.todo++;
                    return acc;
                }, { resto: 0, cooked: 0, todo: 0 });
            }, [state]);

            const slotsByDate = useMemo(() => {
                if (!state || !state.slots) return {};
                return state.slots.reduce((acc, slot) => {
                    if (slot.id === 'breakfast-global') return acc; // Filter out breakfast
                    if (!acc[slot.date]) acc[slot.date] = { name: slot.dayName, slots: [] };
                    acc[slot.date].slots.push(slot);
                    return acc;
                }, {});
            }, [state]);

            const shoppingList = useMemo(() => {
                if (!state || !state.slots) return [];
                const items = {};
                state.slots.forEach(slot => {
                    if (!slot.isRestaurant && slot.ingredients && Array.isArray(slot.ingredients)) {
                        slot.ingredients.forEach(ing => {
                            const nameRaw = ing.name.trim();
                            const name = nameRaw.toLowerCase();
                            if (!name) return;
                            
                            const q = parseFloat(ing.quantity) || 0;
                            const u = ing.unit;
                            
                            const conv = CONVERSIONS[u];
                            let key, normalizedQty;
                             if (conv) { 
                                key = `${name}_${conv.type}`; 
                                normalizedQty = q * conv.factor; 
                            } else { 
                                key = `${name}_${u}`; 
                                normalizedQty = q;
                            }

                            if (!items[key]) {
                                items[key] = { 
                                    name: nameRaw, // Keep one display name (first encountered)
                                    type: conv ? conv.type : 'other', 
                                    unit: u, 
                                    quantity: 0,
                                    sources: new Set(),
                                    refs: [] 
                                }; 
                            }
                            
                            items[key].quantity += normalizedQty;
                            // Add source
                            const sourceName = slot.recipeName ? slot.recipeName : slot.dayName;
                            items[key].sources.add(sourceName);
                            items[key].refs.push({ slotId: slot.id, ingId: ing.id });
                        });
                    }
                });

                return Object.values(items).map(item => {
                    let displayQty = item.quantity;
                    let displayUnit = item.unit;
                    
                    if (item.type === 'weight') { if (item.quantity >= 1000) { displayQty = item.quantity / 1000; displayUnit = 'kg'; } else { displayUnit = 'g'; } } 
                    else if (item.type === 'volume') { if (item.quantity >= 1000) { displayQty = item.quantity / 1000; displayUnit = 'L'; } else if (item.quantity >= 10) { displayQty = item.quantity / 10; displayUnit = 'cl'; } else { displayUnit = 'ml'; } }
                    
                    displayQty = Math.round(displayQty * 100) / 100;

                    // Calculate checked status
                    // Item is checked if all its source ingredients are checked
                    const allChecked = item.refs.every(ref => {
                        const s = state.slots.find(slot => slot.id === ref.slotId);
                        const i = s?.ingredients?.find(ing => ing.id === ref.ingId);
                        return i?.checked;
                    });
                    
                    return { 
                        ...item,
                        displayName: item.name.charAt(0).toUpperCase() + item.name.slice(1), 
                        displayQty, 
                        displayUnit,
                        sources: Array.from(item.sources),
                        checked: allChecked
                    };
                }).sort((a,b) => {
                    // Sort checked items to the bottom optionally, or just keep alphabetical
                    // Let's keep alphabetical for now but checked state visual
                    if (a.checked === b.checked) return a.displayName.localeCompare(b.displayName);
                    return a.checked ? 1 : -1; // Checked items at bottom
                });
            }, [state]);

            if (error) return <div className="p-10 text-red-600 font-bold text-center">ERREUR: {error}</div>;
            if (!state) return <div className="min-h-screen flex items-center justify-center flex-col gap-2 text-blue-600"><Loader2 className="animate-spin" size={40}/><span className="font-bold tracking-widest text-xs uppercase">Chargement...</span></div>;

            return (
                <div className="min-h-screen bg-slate-50 pb-24 text-slate-800">
                    <header className="bg-white px-4 py-3 shadow-sm sticky top-0 z-30 flex justify-between items-center gap-2">
                        <div className="flex flex-col leading-none">
                            <span className="font-black text-sm text-slate-400 tracking-tight">ADDR</span>
                            <span className="font-black text-xl text-slate-900 tracking-tighter">SNOWEEK</span>
                        </div>
                        <div className="flex gap-2 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">
                            <div className="flex flex-col items-center justify-center"><span className="font-black text-xs text-blue-600 leading-none">{stats.cooked}</span><span className="text-[6px] uppercase font-bold text-slate-400">Fait</span></div>
                            <div className="w-px h-5 bg-slate-200"></div>
                             <div className="flex flex-col items-center justify-center"><span className="font-black text-xs text-orange-500 leading-none">{stats.resto}</span><span className="text-[6px] uppercase font-bold text-slate-400">Resto</span></div>
                            <div className="w-px h-5 bg-slate-200"></div>
                             <div className="flex flex-col items-center justify-center"><span className="font-black text-xs text-red-400 leading-none">{stats.todo}</span><span className="text-[6px] uppercase font-bold text-slate-400">Vide</span></div>
                        </div>
                        <button onClick={()=>setIsAdminOpen(true)} className="p-2.5 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors"><Settings size={20} className="text-slate-600"/></button>
                    </header>

                    <main className="max-w-3xl mx-auto p-4">
                        {activeTab === 'planner' ? (
                            <div className="space-y-3">
                                {/* BREAKFAST CARD */}
                                {state.slots.find(s => s.id === 'breakfast-global') && (() => {
                                    const slot = state.slots.find(s => s.id === 'breakfast-global');
                                    const ingredientCount = slot.ingredients ? slot.ingredients.filter(i => i.name && i.name.trim()).length : 0;
                                    return (
                                        <div className="flex gap-2 mb-6 animate-in slide-in-from-top duration-300">
                                            <div className="w-10 pt-2 text-center shrink-0 flex flex-col items-center gap-1">
                                                <div className="p-2 bg-orange-100 rounded-xl text-orange-600 shadow-sm"><Coffee size={20}/></div>
                                            </div>
                                            <div className="flex-1">
                                                <div onClick={() => setSelectedSlot(slot)} className="relative p-3 rounded-2xl border-2 border-orange-100 bg-gradient-to-br from-orange-50 to-white cursor-pointer transition-all hover:shadow-md hover:border-orange-200 group">
                                                    <div className="flex justify-between items-start mb-1 gap-2">
                                                         <div className="flex flex-wrap items-center gap-1.5 flex-1">
                                                            <span className="text-[9px] font-black px-2 py-0.5 rounded bg-orange-100 text-orange-700 uppercase tracking-widest">Tous les matins</span>
                                                            {slot.pax && <span className="text-[9px] font-bold bg-orange-50 px-1.5 py-0.5 rounded text-orange-600 border border-orange-100">{slot.pax} pax</span>}
                                                         </div>
                                                         <div className="p-1 rounded-full hover:bg-orange-100 text-orange-300 transition-colors"><Edit2 size={12}/></div>
                                                    </div>
                                                    <div className="font-bold text-md leading-tight mt-1 text-slate-800">Petit Déjeuner</div>
                                                    <div className="flex items-center gap-2">
                                                        {ingredientCount > 0 ? (
                                                            <span className="mt-2 text-[9px] font-bold text-orange-600">{ingredientCount} produits</span>
                                                        ) : (
                                                            <span className="mt-2 text-[9px] font-medium text-slate-400 italic">Liste vide</span>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })()}

                                {Object.values(slotsByDate).map(day => (
                                    <div key={day.name} className="flex gap-2">
                                        <div className="w-10 pt-2 text-center shrink-0">
                                            <div className="text-[10px] font-black text-slate-400 uppercase">{day.name.substring(0,3)}</div>
                                            <div className="text-xl font-black">{day.name.split(' ')[1]}</div>
                                        </div>
                                        <div className="flex-1 grid gap-3 sm:grid-cols-2">
                                            {day.slots[0].type === 'Soir' && <div className="hidden sm:block bg-slate-50/50 rounded-2xl border-2 border-dashed border-slate-200/50 relative opacity-50"><div className="absolute inset-0 flex items-center justify-center text-slate-300 text-xs font-bold uppercase tracking-widest">Midi (off)</div></div>}
                                            
                                            {day.slots.map(slot => {
                                                const ingredientCount = slot.ingredients ? slot.ingredients.filter(i => i.name && i.name.trim()).length : 0;
                                                return (
                                                <div 
                                                    key={slot.id} 
                                                    draggable="true"
                                                    onDragStart={(e) => handleDragStart(e, slot.id)}
                                                    onDragOver={handleDragOver}
                                                    onDrop={(e) => handleDrop(e, slot.id)}
                                                    onClick={() => handleCardClick(slot)} 
                                                    className={`relative p-3 rounded-2xl border-2 transition-all cursor-pointer group select-none ${
                                                        draggedSlotId === slot.id ? 'border-blue-500 bg-blue-50 scale-95 shadow-inner ring-2 ring-blue-200' : 
                                                        (slot.isRestaurant ? 'bg-slate-50 border-slate-200' : (slot.recipeName ? 'bg-white border-blue-100 shadow-sm' : 'bg-white border-dashed border-red-100'))
                                                    }`}
                                                >
                                                    
                                                    <div className="flex justify-between items-start mb-1 gap-2">
                                                        <div className="flex flex-wrap items-center gap-1.5 flex-1">
                                                            <span className={`text-[9px] font-black px-2 py-0.5 rounded ${slot.type==='Midi'?'bg-yellow-100 text-yellow-700':'bg-indigo-100 text-indigo-700'}`}>{slot.type}</span>
                                                            {slot.pax && <span className="text-[9px] font-bold bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 border border-slate-200">{slot.pax} pax</span>}
                                                            {slot.cooks && Array.isArray(slot.cooks) && slot.cooks.map(c=><span key={c} className="text-[9px] font-bold bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 border border-slate-200">{c}</span>)}
                                                        </div>
                                                        
                                                        <div 
                                                            onClick={(e) => handleMobileMoveClick(e, slot.id)}
                                                            className={`p-1 rounded hover:bg-slate-100 shrink-0 ${draggedSlotId === slot.id ? 'text-blue-600 bg-blue-100' : 'text-slate-300'}`}
                                                        >
                                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>
                                                        </div>
                                                    </div>

                                                    {slot.isRestaurant ? (
                                                        <div className="text-slate-400 font-bold italic text-sm mt-3 flex items-center gap-1.5"><Store size={14}/> Sortie Resto</div>
                                                    ) : (
                                                        <>
                                                            <div className={`font-bold text-md leading-tight mt-1 ${!slot.recipeName && 'text-red-300 italic'}`}>{slot.recipeName || 'À définir...'}</div>
                                                            {ingredientCount > 0 && <div className="mt-2 text-[9px] font-bold text-blue-500">{ingredientCount} ingrédients</div>}
                                                        </>
                                                    )}

                                                    {draggedSlotId && draggedSlotId !== slot.id && (
                                                        <div className="absolute inset-0 bg-blue-500/10 rounded-2xl flex items-center justify-center animate-pulse border-2 border-blue-500 z-10">
                                                            <span className="bg-blue-600 text-white text-[10px] font-bold px-2 py-1 rounded-full shadow-sm">Déposer ici</span>
                                                        </div>
                                                    )}
                                                </div>
                                            )})}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="bg-white rounded-2xl shadow p-6">
                                <h2 className="font-black text-xl mb-4 flex items-center gap-2"><ShoppingCart/> Courses</h2>
                                <div className="space-y-0">
                                    {shoppingList.length === 0 ? <p className="text-slate-400 italic py-4 text-center">Rien à acheter pour le moment.</p> : 
                                    shoppingList.map(item => (
                                        <div key={item.name+item.unit} className={`py-3.5 -mx-2 px-3 rounded-xl flex items-start gap-3 group transition-all border-b border-slate-100 last:border-0 ${item.checked ? 'bg-slate-50 opacity-75' : 'hover:bg-white hover:shadow-sm'}`}>
                                            <button onClick={(e) => {e.stopPropagation(); handleToggleShoppingItem(item);}} className="shrink-0 mt-0.5 text-slate-300 hover:text-blue-600 transition-colors">
                                                {item.checked ? <CheckCircle2 className="text-green-500 fill-green-50" size={20}/> : <Circle size={20}/>}
                                            </button>
                                            
                                            <div onClick={() => setEditingItem(item)} className="flex-1 min-w-0 cursor-pointer flex flex-col gap-1">
                                                <div className="flex justify-between items-start gap-3">
                                                    <div className={`font-bold text-sm leading-snug break-words ${item.checked ? 'line-through text-slate-400 decoration-slate-300' : 'text-slate-800'}`}>
                                                        {item.displayName}
                                                    </div>
                                                    <span className={`shrink-0 font-black text-xs px-2 py-1 rounded-lg shadow-sm transition-colors whitespace-nowrap ${item.checked ? 'bg-slate-200 text-slate-500' : 'bg-blue-50 text-blue-600'}`}>
                                                        {item.displayQty} {item.displayUnit}
                                                    </span>
                                                </div>

                                                <div className={`flex flex-wrap gap-1.5 mt-0.5 ${item.checked ? 'opacity-40' : ''}`}>
                                                    {item.sources.slice(0, 4).map(s => (
                                                        <span key={s} className="text-[9px] font-bold text-yellow-700 bg-yellow-50 border border-yellow-100 px-1.5 py-0.5 rounded truncate max-w-[100px]">
                                                            {s}
                                                        </span>
                                                    ))}
                                                    {item.sources.length > 4 && <span className="text-[9px] font-bold text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">+{item.sources.length - 4}</span>}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {selectedSlot && <MealEditModal slot={selectedSlot} participants={state.participants} onClose={()=>setSelectedSlot(null)} onSave={(updatedSlot) => { const newSlots = state.slots.map(s => s.id === updatedSlot.id ? updatedSlot : s); save({...state, slots: newSlots}); setSelectedSlot(null); }} />}
                    
                    {editingItem && <ShoppingItemEditModal item={editingItem} onClose={()=>setEditingItem(null)} onSave={handleShoppingItemUpdate} />}

                    {isAdminOpen && <SettingsModal onClose={()=>setIsAdminOpen(false)} state={state} onSave={handleScheduleUpdate} onReset={resetAll} />}

                    <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/80 backdrop-blur-md border border-white/50 p-1.5 rounded-full shadow-2xl flex gap-1 z-40">
                        <button onClick={()=>setActiveTab('planner')} className={`px-6 py-3 rounded-full font-black text-sm transition-all flex items-center gap-2 ${activeTab==='planner'?'bg-blue-600 text-white shadow-lg shadow-blue-200':'text-slate-400'}`}><Calendar size={18}/> Planning</button>
                        <button onClick={()=>setActiveTab('shopping')} className={`px-6 py-3 rounded-full font-black text-sm transition-all flex items-center gap-2 ${activeTab==='shopping'?'bg-blue-600 text-white shadow-lg shadow-blue-200':'text-slate-400'}`}><ShoppingCart size={18}/> Courses</button>
                    </nav>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Application collaborative Snoweek">
    <title>ADDR SNOWEEK - LIVE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        h1, h2, h3 { font-family: 'Outfit', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select, textarea { font-size: 16px !important; } 
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getDatabase, ref, onValue, set } from 'firebase/database';
        import { 
            Calendar, ShoppingCart, Utensils, Settings, RotateCcw, X, Users, Type, 
            CheckCircle2, Plus, Trash2, Save, Store, ChefHat, UtensilsCrossed, 
            Search, Printer, Circle, Loader2, ArrowRight, ArrowDown
        } from 'lucide-react';

        // --- 1. CONFIGURATION FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVWhMBU1_j1sM78EahtaMX8KAlsiGUUFA",
            authDomain: "addrsnoweek.firebaseapp.com",
            databaseURL: "https://addrsnoweek-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "addrsnoweek",
            storageBucket: "addrsnoweek.firebasestorage.app",
            messagingSenderId: "466240679395",
            appId: "1:466240679395:web:a59f6a72e061560a1f44d6",
            measurementId: "G-VLPH0412KY"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const DB_PATH = 'snoweek_data_v1'; 

        // --- CONSTANTES ---
        const DEFAULT_PARTICIPANTS = ["Amau", "Ani", "David", "Jojo", "Laure", "Léo", "Lucile", "Nathan", "Paloma", "Ségo", "Solé", "Thib", "Youri"];
        const UNITS = ["unité(s)", "g", "kg", "ml", "cl", "L", "cuillère(s)", "pincée(s)", "paquet(s)", "botte(s)"];
        const DAYS_OF_WEEK = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
        const MONTHS = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];

        const CONVERSIONS = {
            'g': { type: 'weight', factor: 1 },
            'kg': { type: 'weight', factor: 1000 },
            'ml': { type: 'volume', factor: 1 },
            'cl': { type: 'volume', factor: 10 },
            'L': { type: 'volume', factor: 1000 },
        };

        // --- UTILITAIRES ---
        const formatDate = (date) => {
            const y = date.getFullYear();
            const m = MONTHS[date.getMonth()];
            const d = date.getDate().toString().padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const getDayLabel = (date) => {
            const d = date.getDate().toString().padStart(2, '0');
            return `${DAYS_OF_WEEK[date.getDay()]} ${d}`;
        };

        const addDays = (dateStr, days) => {
            const date = new Date(dateStr);
            date.setDate(date.getDate() + days);
            return formatDate(date);
        };

        const generateSchedule = (startDateStr, startPeriod, endDateStr, endPeriod) => {
            let current = new Date(startDateStr);
            const end = new Date(endDateStr);
            const slots = [];
            let guard = 0;
            let isMidi = startPeriod === 'Midi';

            while (guard < 100) {
                const dateStr = formatDate(current);
                if (current > end) break;
                if (dateStr === endDateStr) {
                    if (endPeriod === 'Midi' && !isMidi) break; 
                }
                const type = isMidi ? 'Midi' : 'Soir';
                
                // CORRECTION : Initialisation explicite des tableaux vides
                slots.push({
                    id: `${dateStr}-${type}`,
                    date: dateStr,
                    dayName: getDayLabel(current),
                    type: type,
                    isRestaurant: false,
                    recipeName: '',
                    cooks: [], 
                    ingredients: []
                });

                if (dateStr === endDateStr && ((endPeriod === 'Midi' && type === 'Midi') || (endPeriod === 'Soir' && type === 'Soir'))) break;
                if (!isMidi) current.setDate(current.getDate() + 1);
                isMidi = !isMidi;
                guard++;
            }
            return slots;
        };

        const DEFAULT_START_DATE = '2026-01-24';
        const DEFAULT_START_PERIOD = 'Midi';
        const DEFAULT_END_DATE = '2026-02-01';
        const DEFAULT_END_PERIOD = 'Midi';
        const INITIAL_SLOTS = generateSchedule(DEFAULT_START_DATE, DEFAULT_START_PERIOD, DEFAULT_END_DATE, DEFAULT_END_PERIOD);

        const DEFAULT_STATE = {
            startDate: DEFAULT_START_DATE,
            startPeriod: DEFAULT_START_PERIOD,
            endDate: DEFAULT_END_DATE,
            endPeriod: DEFAULT_END_PERIOD,
            slots: INITIAL_SLOTS,
            participants: DEFAULT_PARTICIPANTS,
            tripName: 'ADDR SNOWEEK',
            version: 3
        };

        // --- COMPOSANTS ---

        const ParticipantManager = ({ participants, onChange }) => {
            // Protection contre undefined
            const safeParticipants = participants || [];
            
            const [newName, setNewName] = useState('');
            const handleAdd = (e) => {
                e.preventDefault();
                if (newName.trim() && !safeParticipants.includes(newName.trim())) {
                    onChange([...safeParticipants, newName.trim()].sort());
                    setNewName('');
                }
            };
            return (
                <div className="space-y-4">
                    <form onSubmit={handleAdd} className="flex gap-2">
                        <input type="text" value={newName} onChange={(e) => setNewName(e.target.value)} placeholder="Nouveau nom..." className="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl font-bold text-base text-slate-900"/>
                        <button type="submit" disabled={!newName.trim()} className="px-3 bg-blue-600 text-white rounded-xl"><Plus size={20}/></button>
                    </form>
                    <div className="flex flex-wrap gap-2">
                        {safeParticipants.map((name) => (
                            <div key={name} className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 border border-slate-200 rounded-lg text-xs font-bold text-slate-700">
                                {name} <button onClick={() => safeParticipants.length > 1 ? onChange(safeParticipants.filter(p => p !== name)) : alert("Impossible de tout supprimer")} className="text-red-400 font-bold ml-1 hover:text-red-600">x</button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ onClose, state, onSave, onReset }) => {
            const [localStart, setLocalStart] = useState(state.startDate || DEFAULT_START_DATE);
            const [localStartPeriod, setLocalStartPeriod] = useState(state.startPeriod || 'Midi');
            const [localEnd, setLocalEnd] = useState(state.endDate || addDays(state.startDate, 7));
            const [localEndPeriod, setLocalEndPeriod] = useState(state.endPeriod || 'Midi');

            const handleApply = () => {
                if (window.confirm("Attention : Modifier les dates va régénérer la structure du planning. Continuer ?")) {
                    onSave(localStart, localStartPeriod, localEnd, localEndPeriod);
                }
            };

            return (
                <div className="fixed inset-0 z-50 bg-black/50 flex justify-end animate-in fade-in duration-200">
                    <div className="bg-white w-full max-w-sm h-full p-6 overflow-y-auto shadow-2xl animate-in slide-in-from-right duration-300">
                        <div className="flex justify-between items-center mb-8"><h2 className="font-black text-2xl tracking-tight">Paramètres</h2><button onClick={onClose} className="p-2 bg-slate-50 rounded-full"><X/></button></div>
                        <div className="space-y-8">
                            <section className="space-y-4">
                                <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2"><Calendar size={14}/> Dates du séjour</h3>
                                <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-4">
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Début</label>
                                        <div className="flex flex-col gap-2 mt-1">
                                            <input type="date" className="w-full p-3 bg-white border-2 border-slate-200 rounded-xl font-bold text-slate-900" value={localStart} onChange={(e) => setLocalStart(e.target.value)}/>
                                            <div className="flex bg-white rounded-xl p-1 border-2 border-slate-200">
                                                {['Midi', 'Soir'].map(p => (<button key={p} onClick={() => setLocalStartPeriod(p)} className={`flex-1 py-1.5 rounded-lg text-xs font-black transition-all ${localStartPeriod === p ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400'}`}>{p}</button>))}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex justify-center text-slate-300"><ArrowDown size={16}/></div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Fin</label>
                                        <div className="flex flex-col gap-2 mt-1">
                                            <input type="date" className="w-full p-3 bg-white border-2 border-slate-200 rounded-xl font-bold text-slate-900" value={localEnd} onChange={(e) => setLocalEnd(e.target.value)}/>
                                            <div className="flex bg-white rounded-xl p-1 border-2 border-slate-200">
                                                {['Midi', 'Soir'].map(p => (<button key={p} onClick={() => setLocalEndPeriod(p)} className={`flex-1 py-1.5 rounded-lg text-xs font-black transition-all ${localEndPeriod === p ? 'bg-blue-600 text-white shadow-sm' : 'text-slate-400'}`}>{p}</button>))}
                                            </div>
                                        </div>
                                    </div>
                                    <button onClick={handleApply} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200 mt-2 text-sm flex justify-center items-center gap-2"><RotateCcw size={16}/> Mettre à jour</button>
                                </div>
                            </section>
                            <section className="space-y-4"><h3 className="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2"><Users size={14}/> Participants</h3><ParticipantManager participants={state.participants} onChange={p => onSave(null, null, null, null, p)}/></section>
                            <div className="pt-8 border-t"><button onClick={onReset} className="w-full py-4 bg-red-50 text-red-500 font-bold rounded-xl flex items-center justify-center gap-2 hover:bg-red-100 transition-colors"><Trash2 size={16}/> Réinitialiser tout</button></div>
                        </div>
                    </div>
                </div>
            );
        };

        const MealEditModal = ({ slot, participants, onClose, onSave }) => {
            const [localSlot, setLocalSlot] = useState(slot);
            const [lastAddedId, setLastAddedId] = useState(null);
            const nameInputRefs = useRef({});
            
            // CORRECTION CRITIQUE : Protection contre undefined pour cooks et ingredients
            const safeSlot = { 
                recipeName: '', 
                isRestaurant: false, 
                cooks: [], 
                ingredients: [], 
                ...localSlot 
            };
            
            // Double sécurité : si localSlot avait 'cooks: undefined', le spread ...localSlot écrasait le défaut. 
            // On force les tableaux vides ici.
            if (!safeSlot.cooks) safeSlot.cooks = [];
            if (!safeSlot.ingredients) safeSlot.ingredients = [];

            const addIng = () => {
                const newId = crypto.randomUUID();
                setLastAddedId(newId);
                setLocalSlot({...safeSlot, ingredients: [...safeSlot.ingredients, {id: newId, name:'', quantity:1, unit: UNITS[0]}]});
            };
            const updateIng = (id, f, v) => setLocalSlot({...safeSlot, ingredients: safeSlot.ingredients.map(i=>i.id===id?{...i,[f]:v}:i)});
            
            const toggleCook = (name) => {
                const currentCooks = safeSlot.cooks || [];
                setLocalSlot({
                    ...safeSlot, 
                    cooks: currentCooks.includes(name) ? currentCooks.filter(c => c !== name) : [...currentCooks, name]
                });
            };

            useEffect(() => {
                if (lastAddedId && nameInputRefs.current[lastAddedId]) {
                    nameInputRefs.current[lastAddedId].focus();
                    setLastAddedId(null);
                }
            }, [lastAddedId, safeSlot.ingredients]);

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/80 p-0 sm:p-4 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-none sm:rounded-2xl w-full h-full sm:h-auto sm:max-h-[90vh] sm:max-w-lg shadow-2xl flex flex-col overflow-hidden">
                        <div className="px-4 py-3 border-b flex justify-between items-center bg-white shrink-0">
                            <div><h2 className="font-black text-lg text-slate-900 leading-none">{slot.dayName}</h2><p className="text-blue-500 text-xs font-black uppercase tracking-widest">{slot.type}</p></div>
                            <div className="flex items-center gap-2 bg-slate-100 p-1 pr-3 rounded-full">
                                <button onClick={() => setLocalSlot({...safeSlot, isRestaurant: !safeSlot.isRestaurant})} className={`w-9 h-5 rounded-full relative transition-colors duration-200 ${safeSlot.isRestaurant ? 'bg-orange-500' : 'bg-slate-300'}`}><div className={`w-3.5 h-3.5 bg-white rounded-full absolute top-0.5 transition-all duration-200 shadow-sm ${safeSlot.isRestaurant ? 'left-[1.1rem]' : 'left-1'}`}/></button>
                                <span className={`text-[10px] font-black uppercase ${safeSlot.isRestaurant ? 'text-orange-500' : 'text-slate-400'}`}>{safeSlot.isRestaurant ? 'Resto' : 'Cuisine'}</span>
                            </div>
                            <button onClick={onClose} className="p-2 bg-slate-50 hover:bg-slate-100 rounded-full text-slate-400"><X size={20}/></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-5 bg-slate-50/50">
                            {safeSlot.isRestaurant ? (
                                <div className="flex flex-col items-center justify-center h-64 text-slate-400 animate-in zoom-in-95"><Store size={48} className="text-orange-300 mb-3"/><p className="font-black text-lg text-orange-400 uppercase">Sortie Restaurant</p><p className="text-xs font-medium text-slate-400 mt-1">Aucune course nécessaire</p></div>
                            ) : (
                                <>
                                    <div className="space-y-1.5"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Au Menu</label><input className="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:outline-none font-bold text-base text-slate-900 shadow-sm placeholder:text-slate-300" placeholder="Ex: Tartiflette..." value={safeSlot.recipeName} onChange={e=>setLocalSlot({...safeSlot, recipeName: e.target.value})}/></div>
                                    <div className="space-y-1.5"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Chefs Cuistots</label><div className="flex flex-wrap gap-1.5">{participants.map(p => (<button key={p} onClick={() => toggleCook(p)} className={`px-3 py-2 rounded-lg text-xs font-bold border transition-all active:scale-95 ${safeSlot.cooks.includes(p)? 'bg-blue-600 border-blue-600 text-white shadow-md' : 'bg-white border-slate-200 text-slate-500'}`}>{p}</button>))}</div></div>
                                    <div className="space-y-2 pt-2">
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Liste des Ingrédients</label>
                                        <div className="space-y-2">
                                            {safeSlot.ingredients.length === 0 && (<div className="text-center py-6 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50"><p className="text-xs text-slate-400 font-medium">Liste vide</p></div>)}
                                            {safeSlot.ingredients.map(ing => (
                                                <div key={ing.id} className="flex gap-2 animate-in slide-in-from-left-2 duration-200">
                                                    <input type="number" className="w-16 px-2 py-3 bg-white border border-slate-200 rounded-lg text-center text-base font-bold text-slate-900 focus:border-blue-500 focus:outline-none" value={ing.quantity} onChange={e=>updateIng(ing.id,'quantity',e.target.value)}/>
                                                    <select className="w-20 px-1 py-3 bg-white border border-slate-200 rounded-lg text-[11px] font-bold text-slate-600 focus:border-blue-500 focus:outline-none text-center" value={ing.unit} onChange={e=>updateIng(ing.id,'unit',e.target.value)}>{UNITS.map(u => <option key={u} value={u}>{u}</option>)}</select>
                                                    <input ref={el => nameInputRefs.current[ing.id] = el} className="flex-1 px-3 py-3 bg-white border border-slate-200 rounded-lg text-base font-bold text-slate-900 focus:border-blue-500 focus:outline-none placeholder:text-slate-300" placeholder="Ingrédient..." value={ing.name} onChange={e=>updateIng(ing.id,'name',e.target.value)}/>
                                                    <button onClick={()=>setLocalSlot({...safeSlot, ingredients: safeSlot.ingredients.filter(i=>i.id!==ing.id)})} className="px-2 text-slate-300 hover:text-red-500 transition-colors"><Trash2 size={20}/></button>
                                                </div>
                                            ))}
                                        </div>
                                        <button onClick={addIng} className="w-full mt-3 py-3 rounded-xl border-2 border-dashed border-blue-200 bg-blue-50 text-blue-600 font-black text-sm flex items-center justify-center gap-2 hover:bg-blue-100 transition-all active:scale-[0.98]"><Plus size={18}/> Ajouter un ingrédient</button>
                                    </div>
                                </>
                            )}
                        </div>
                        <div className="p-3 border-t bg-white flex gap-3 shrink-0 pb-6 sm:pb-3">
                            <button onClick={onClose} className="flex-1 py-2.5 rounded-lg border border-slate-200 text-slate-500 font-bold text-sm hover:bg-slate-50 transition-all">Annuler</button>
                            <button onClick={()=>onSave(localSlot)} className="flex-[2] py-2.5 bg-blue-600 text-white rounded-lg font-black text-sm shadow-lg shadow-blue-100 flex items-center justify-center gap-2 active:scale-95 transition-all"><Save size={16}/> Enregistrer</button>
                        </div>
                    </div>
                </div>
            )
        };

        const App = () => {
            const [state, setState] = useState(null);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('planner');
            const [isAdminOpen, setIsAdminOpen] = useState(false);
            const [selectedSlot, setSelectedSlot] = useState(null);

            // CONNEXION FIREBASE
            useEffect(() => {
                const dataRef = ref(db, DB_PATH);
                const unsubscribe = onValue(dataRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) setState(data); else set(dataRef, DEFAULT_STATE);
                }, (err) => {
                    console.error(err);
                    setError(err.message);
                });
                return () => unsubscribe();
            }, []);

            const save = (newState) => {
                setState(newState);
                set(ref(db, DB_PATH), newState).catch(e => alert("Erreur sauvegarde: "+e.message));
            };

            const handleScheduleUpdate = (newStart, newStartPeriod, newEnd, newEndPeriod, newParticipants) => {
                if (newParticipants) {
                    save({...state, participants: newParticipants});
                    return;
                }
                const newSlots = generateSchedule(newStart, newStartPeriod, newEnd, newEndPeriod);
                const mergedSlots = newSlots.map((newSlot, index) => {
                    if (state.slots[index]) {
                        const old = state.slots[index];
                        // CORRECTION CRITIQUE : Protection lors de la fusion des anciens slots
                        return { 
                            ...newSlot, 
                            recipeName: old.recipeName || '', 
                            isRestaurant: old.isRestaurant || false, 
                            cooks: old.cooks || [], 
                            ingredients: old.ingredients || [] 
                        };
                    }
                    return newSlot;
                });
                save({ ...state, startDate: newStart, startPeriod: newStartPeriod, endDate: newEnd, endPeriod: newEndPeriod, slots: mergedSlots });
                setIsAdminOpen(false);
            };

            const stats = useMemo(() => {
                if (!state || !state.slots) return { resto: 0, cooked: 0, todo: 0 };
                return state.slots.reduce((acc, slot) => {
                    if (slot.isRestaurant) acc.resto++;
                    else if (slot.recipeName && slot.recipeName.trim() !== '') acc.cooked++;
                    else acc.todo++;
                    return acc;
                }, { resto: 0, cooked: 0, todo: 0 });
            }, [state]);

            const slotsByDate = useMemo(() => {
                if (!state || !state.slots) return {};
                return state.slots.reduce((acc, slot) => {
                    if (!acc[slot.date]) acc[slot.date] = { name: slot.dayName, slots: [] };
                    acc[slot.date].slots.push(slot);
                    return acc;
                }, {});
            }, [state]);

            const shoppingList = useMemo(() => {
                if (!state || !state.slots) return [];
                const items = {};
                state.slots.forEach(slot => {
                    // Protection contre undefined ingredients
                    if (!slot.isRestaurant && slot.ingredients && Array.isArray(slot.ingredients)) {
                        slot.ingredients.forEach(ing => {
                            const name = ing.name.toLowerCase().trim();
                            if (!name) return;
                            const q = parseFloat(ing.quantity) || 0;
                            const u = ing.unit;
                            const conv = CONVERSIONS[u];
                            let key, normalizedQty = q;
                            if (conv) {
                                key = `${name}_${conv.type}`;
                                normalizedQty = q * conv.factor;
                            } else {
                                key = `${name}_${u}`;
                            }
                            if (!items[key]) {
                                items[key] = { name: ing.name.trim(), type: conv ? conv.type : 'other', unit: u, quantity: 0 };
                            }
                            items[key].quantity += normalizedQty;
                        });
                    }
                });
                return Object.values(items).map(item => {
                    let displayQty = item.quantity;
                    let displayUnit = item.unit;
                    if (item.type === 'weight') {
                        if (item.quantity >= 1000) { displayQty = item.quantity / 1000; displayUnit = 'kg'; } else { displayUnit = 'g'; }
                    } else if (item.type === 'volume') {
                        if (item.quantity >= 1000) { displayQty = item.quantity / 1000; displayUnit = 'L'; } else if (item.quantity >= 10) { displayQty = item.quantity / 10; displayUnit = 'cl'; } else { displayUnit = 'ml'; }
                    }
                    displayQty = Math.round(displayQty * 100) / 100;
                    return { name: item.name.charAt(0).toUpperCase() + item.name.slice(1), q: displayQty, unit: displayUnit };
                }).sort((a,b) => a.name.localeCompare(b.name));
            }, [state]);

            const handleToggleRestaurant = (e, slot) => {
                e.stopPropagation(); 
                const updatedSlot = { 
                    ...slot, 
                    isRestaurant: !slot.isRestaurant, 
                    recipeName: !slot.isRestaurant ? '' : slot.recipeName, 
                    // CORRECTION CRITIQUE : Protection contre undefined ici aussi
                    cooks: !slot.isRestaurant ? [] : (slot.cooks || []), 
                    ingredients: !slot.isRestaurant ? [] : (slot.ingredients || []) 
                };
                const newSlots = state.slots.map(s => s.id === slot.id ? updatedSlot : s);
                save({...state, slots: newSlots});
            };

            if (error) return <div className="p-10 text-red-600 font-bold text-center">ERREUR: {error}</div>;
            if (!state) return <div className="min-h-screen flex items-center justify-center flex-col gap-2 text-blue-600"><Loader2 className="animate-spin" size={40}/><span className="font-bold tracking-widest text-xs uppercase">Chargement...</span></div>;

            return (
                <div className="min-h-screen bg-slate-50 pb-24 text-slate-800">
                    <header className="bg-white px-4 py-3 shadow-sm sticky top-0 z-30 flex justify-between items-center gap-2">
                        <div className="flex flex-col leading-none">
                            <span className="font-black text-sm text-slate-400 tracking-tight">ADDR</span>
                            <span className="font-black text-xl text-slate-900 tracking-tighter">SNOWEEK</span>
                        </div>
                        <div className="flex gap-2 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">
                            <div className="flex flex-col items-center justify-center"><span className="font-black text-xs text-blue-600 leading-none">{stats.cooked}</span><span className="text-[6px] uppercase font-bold text-slate-400">Fait</span></div>
                            <div className="w-px h-5 bg-slate-200"></div>
                             <div className="flex flex-col items-center justify-center"><span className="font-black text-xs text-orange-500 leading-none">{stats.resto}</span><span className="text-[6px] uppercase font-bold text-slate-400">Resto</span></div>
                            <div className="w-px h-5 bg-slate-200"></div>
                             <div className="flex flex-col items-center justify-center"><span className="font-black text-xs text-red-400 leading-none">{stats.todo}</span><span className="text-[6px] uppercase font-bold text-slate-400">Vide</span></div>
                        </div>
                        <button onClick={()=>setIsAdminOpen(true)} className="p-2.5 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors"><Settings size={20} className="text-slate-600"/></button>
                    </header>

                    <main className="max-w-3xl mx-auto p-4">
                        {activeTab === 'planner' ? (
                            <div className="space-y-3">
                                {Object.values(slotsByDate).map(day => (
                                    <div key={day.name} className="flex gap-2">
                                        <div className="w-10 pt-2 text-center shrink-0">
                                            <div className="text-[10px] font-black text-slate-400 uppercase">{day.name.substring(0,3)}</div>
                                            <div className="text-xl font-black">{day.name.split(' ')[1]}</div>
                                        </div>
                                        <div className="flex-1 grid gap-3 sm:grid-cols-2">
                                            {day.slots.map(slot => (
                                                <div key={slot.id} onClick={()=>setSelectedSlot(slot)} className={`relative p-4 rounded-2xl border-2 transition-all active:scale-95 cursor-pointer ${slot.isRestaurant ? 'bg-slate-50 border-slate-200' : (slot.recipeName ? 'bg-white border-blue-100 shadow-sm' : 'bg-white border-dashed border-red-100')}`}>
                                                    <div className="flex justify-between mb-1">
                                                        <span className={`text-[9px] font-black px-2 py-0.5 rounded ${slot.type==='Midi'?'bg-yellow-100 text-yellow-700':'bg-indigo-100 text-indigo-700'}`}>{slot.type}</span>
                                                        {slot.isRestaurant && <span className="text-[9px] font-black text-orange-500 bg-orange-100 px-2 py-0.5 rounded">RESTO</span>}
                                                    </div>
                                                    {slot.isRestaurant ? (
                                                        <div className="text-slate-400 font-bold italic text-sm mt-2 flex items-center gap-1.5"><Store size={14}/> Sortie Resto</div>
                                                    ) : (
                                                        <>
                                                            <div className={`font-bold text-md leading-tight ${!slot.recipeName && 'text-red-300 italic'}`}>{slot.recipeName || 'À définir...'}</div>
                                                            <div className="flex flex-wrap gap-1 mt-2">
                                                                {slot.cooks && Array.isArray(slot.cooks) && slot.cooks.map(c=><span key={c} className="text-[9px] font-bold bg-slate-100 px-1.5 py-0.5 rounded text-slate-500">{c}</span>)}
                                                            </div>
                                                            {slot.ingredients && Array.isArray(slot.ingredients) && slot.ingredients.length > 0 && <div className="mt-2 text-[9px] font-bold text-blue-500">{slot.ingredients.length} ingrédients</div>}
                                                        </>
                                                    )}
                                                    
                                                    <div className="absolute bottom-3 right-3 z-20" onClick={(e) => e.stopPropagation()}>
                                                        <button onClick={(e) => handleToggleRestaurant(e, slot)} title="Basculer Resto" className={`relative inline-flex h-6 w-11 items-center rounded-full transition-all ring-1 ring-inset shadow-sm ${slot.isRestaurant ? 'bg-orange-500 ring-orange-600' : 'bg-slate-200 ring-slate-300 hover:bg-slate-300'}`}>
                                                            <span className={`${slot.isRestaurant ? 'translate-x-6' : 'translate-x-1'} inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 shadow-sm`} />
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="bg-white rounded-2xl shadow p-6">
                                <h2 className="font-black text-xl mb-4 flex items-center gap-2"><ShoppingCart/> Courses</h2>
                                <div className="space-y-0 divide-y">
                                    {shoppingList.length === 0 ? <p className="text-slate-400 italic py-4 text-center">Rien à acheter pour le moment.</p> : 
                                    shoppingList.map(item => (
                                        <div key={item.name+item.unit} className="flex justify-between py-3">
                                            <span className="font-bold text-slate-700">{item.name}</span>
                                            <span className="font-black text-sm bg-blue-50 text-blue-600 px-2 py-1 rounded">{item.q} {item.unit}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {selectedSlot && <MealEditModal slot={selectedSlot} participants={state.participants} onClose={()=>setSelectedSlot(null)} onSave={(updatedSlot) => { const newSlots = state.slots.map(s => s.id === updatedSlot.id ? updatedSlot : s); save({...state, slots: newSlots}); setSelectedSlot(null); }} />}

                    {isAdminOpen && <SettingsModal onClose={()=>setIsAdminOpen(false)} state={state} onSave={handleScheduleUpdate} onReset={()=>{if(confirm('Tout effacer ?')) save(DEFAULT_STATE)}} />}

                    <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/80 backdrop-blur-md border border-white/50 p-1.5 rounded-full shadow-2xl flex gap-1 z-40">
                        <button onClick={()=>setActiveTab('planner')} className={`px-6 py-3 rounded-full font-black text-sm transition-all flex items-center gap-2 ${activeTab==='planner'?'bg-blue-600 text-white shadow-lg shadow-blue-200':'text-slate-400'}`}><Calendar size={18}/> Planning</button>
                        <button onClick={()=>setActiveTab('shopping')} className={`px-6 py-3 rounded-full font-black text-sm transition-all flex items-center gap-2 ${activeTab==='shopping'?'bg-blue-600 text-white shadow-lg shadow-blue-200':'text-slate-400'}`}><ShoppingCart size={18}/> Courses</button>
                    </nav>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
